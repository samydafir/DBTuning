\documentclass[11pt]{scrartcl}

\usepackage[top=2cm]{geometry}
%\pagestyle{empty}

\title{
  \textbf{\large Database Tuning -- Assignment 4}\\
  Index Tuning
}

\author{
	A2\\
	\large Baumgartner Dominik, 0920177 \\
	\large Dafir Thomas Samy, 1331483 \\
	\large Sch\"orgnhofer Kevin, 1421082
}

\begin{document}

\maketitle

\noindent
{\it Notes:}
\begin{itemize}\itemsep=0pt
\item Do not forget to run {\tt ANALYZE tablename} after creating or
  changing a table.
\item Use {\tt EXPLAIN ANALYZE} for the query plans that you display in the report.
\end{itemize}


\section{Experimental Setup}

We send our queries with a small java program to the database server. The java program was running on the computers of the R\"UR.\\
The time measurement starts before we start sending the queries of one type and one table (different tables for different indexes) and stops afterwards. We repeat this for each query type and for each table.

\section{Clustered B$^+$-Tree Index}

\paragraph{Point Query}

{\small
\begin{verbatim}
SELECT * FROM Publ WHERE pubID = ...
\end{verbatim}
}



\noindent
For this query we created a text file containing about 20000 randomly selected pubids from the publ.tsv file. Queries were then executed for each entry in that file.

\smallskip\noindent
Runtime: 65155ms. \\
Queries: 19728.
Throughput: about 302 queries/sec.

\smallskip\noindent
Query plan (for one of the queries):
{\small
\begin{verbatim}
Index Scan using pubidcb on publ_cb  (cost=0.43..8.45 rows=1 width=113) (actual time=0.061..0.061 rows=1 loops=1)
Index Cond: ((pubid)::text = 'books/idea/encyclopediaDB2005/Manjunath05'::text)
Planning time: 0.314 ms
Execution time: 0.079 ms
\end{verbatim}
}

\paragraph{Multipoint Query -- Low Selectivity}

Repeat the following query multiple times with different conditions for {\tt booktitle}.

{\small
\begin{verbatim}
SELECT * FROM Publ WHERE booktitle = ...
\end{verbatim}
}

\noindent
Which conditions did you use?\\
We used a equality condition where the index matches a given string from the booktitle row of the publ.tsv file, like 'Software Engineering (Workshops)'.

\smallskip\noindent
Show the runtime results and compute the throughput.\\
For the Clustered B$^+$-Tree Index we achieved a runtime from 9366$ms$ to 10196$ms$ with 719 searched values.
This leads to a throughput of 70,5$\frac{queries}{second}$ to 76,8$\frac{queries}{second}$.\\
\newpage
Query plan (for one of the queries):
\begin{verbatim}
EXPLAIN SELECT * FROM publ_cb WHERE booktitle = 'Software Engineering (Workshops)';

 Index Scan using booktitlecb on publ_cb  (cost=0.43..14.60 rows=181 width=112)
   Index Cond: ((booktitle)::text = 'Software Engineering (Workshops)'::text)
(2 rows)
\end{verbatim}

\paragraph{Multipoint Query -- High Selectivity}

Repeat the following query multiple times with different conditions for {\tt year}.

{\small
\begin{verbatim}
SELECT * FROM Publ WHERE year = ...
\end{verbatim}
}

\noindent
Which conditions did you use?\\
The conditions were imported from a file which contains the years from 1920-2020 repeated up to a total amount of 1500 years.

\smallskip\noindent
Show the runtime results and compute the throughput.\\
Runtime (ms): 86316
Throughput (q/s): 17.37800639510635

\smallskip\noindent
Query plan (for one of the queries):
{\small
\begin{verbatim}
 Bitmap Heap Scan on publ_cb  (cost=45.98..6695.42 rows=2265 width=112) (actual time=1.081..6.685 rows=9182 loops=1)
   Recheck Cond: ((year)::text = '1986'::text)
   Heap Blocks: exact=160
   ->  Bitmap Index Scan on yearcb  (cost=0.00..45.41 rows=2265 width=0) (actual time=1.049..1.049 rows=9182 loops=1)
         Index Cond: ((year)::text = '1986'::text)
 Planning time: 0.484 ms
 Execution time: 9.974 ms
\end{verbatim}
}

\section{Non-Clustered B$^+$-Tree Index}

\noindent \emph{Note:} Make sure the data is not physically ordered by
the indexed attributes due to the clustering index that you created
before.

\paragraph{Point Query}

{\small
\begin{verbatim}
SELECT * FROM Publ WHERE pubID = ...
\end{verbatim}
}

\noindent
For this query we created a text file containing about 20000 randomly selected pubids from the publ.tsv file. Queries were then executed for each entry in that file.

\smallskip\noindent
Runtime: 64573ms. \\
Queries: 19728.
Throughput: about 305 queries/sec.

\smallskip\noindent
Query plan (for one of the queries):
{\small
\begin{verbatim}
Index Scan using pubidb on publ_b  (cost=0.43..8.45 rows=1 width=112) (actual time=0.071..0.072 rows=1 loops=1)
Index Cond: ((pubid)::text = 'books/idea/encyclopediaDB2005/Manjunath05'::text)
Planning time: 0.405 ms
Execution time: 0.092 ms
\end{verbatim}
}


\paragraph{Multipoint Query -- Low Selectivity}

Repeat the following query multiple times with different conditions for {\tt booktitle}.

{\small
\begin{verbatim}
SELECT * FROM Publ WHERE booktitle = ...
\end{verbatim}
}

\noindent
Which conditions did you use?\\
We used a equality condition where the index matches a given string from the booktitle row of the publ.tsv file, like 'Software Engineering (Workshops)'.

\smallskip\noindent
Show the runtime results and compute the throughput.\\
For the Non-Clustered B$^+$-Tree Index we achieved a runtime from 9916$ms$ to 11347$ms$ with 719 searched values.
This leads to a throughput of 63,4$\frac{queries}{second}$ to 72,5$\frac{queries}{second}$.\\

\smallskip\noindent
Query plan (for one of the queries):
\begin{verbatim}
EXPLAIN SELECT * FROM publ_b WHERE booktitle = 'Software Engineering (Workshops)';

 Index Scan using booktitleb on publ_b  (cost=0.43..577.16 rows=181 width=113)
   Index Cond: ((booktitle)::text = 'Software Engineering (Workshops)'::text)
(2 rows)
\end{verbatim}



\paragraph{Multipoint Query -- High Selectivity}

Repeat the following query multiple times with different conditions for {\tt year}.

{\small
\begin{verbatim}
SELECT * FROM Publ WHERE year = ...
\end{verbatim}
}

\noindent
Which conditions did you use?\\
The conditions were imported from a file which contains the years from 1920-2020 repeated up to a total amount of 1500 years.

\smallskip\noindent
Show the runtime results and compute the throughput.\\
Runtime (ms): 83157
Throughput (q/s): 18.038168765106967

\smallskip\noindent
Query plan (for one of the queries):
{\small
\begin{verbatim}
 Bitmap Heap Scan on publ_b  (cost=55.01..7010.65 rows=2398 width=112) (actual time=2.148..34.510 rows=9182 loops=1)
   Recheck Cond: ((year)::text = '1986'::text)
   Heap Blocks: exact=3258
   ->  Bitmap Index Scan on yearb  (cost=0.00..54.41 rows=2398 width=0) (actual time=1.620..1.620 rows=9182 loops=1)
         Index Cond: ((year)::text = '1986'::text)
 Planning time: 0.301 ms
 Execution time: 38.380 ms
\end{verbatim}
}

\section{Non-Clustered Hash Index}

\noindent \emph{Note:} Make sure the data is not physically ordered by
the indexed attributes due to the clustering index that you created
before.

\paragraph{Point Query}

{\small
\begin{verbatim}
SELECT * FROM Publ WHERE pubID = ...
\end{verbatim}
}

\noindent
For this query we created a text file containing about 20000 randomly selected pubids from the publ.tsv file. Queries were then executed for each entry in that file.

\smallskip\noindent
Runtime: 64503ms. \\
Queries: 19728.
Throughput: about 305 queries/sec.

\smallskip\noindent
Query plan (for one of the queries):
{\small
\begin{verbatim}
Index Scan using pubidh on publ_h  (cost=0.00..8.02 rows=1 width=113) (actual time=0.037..0.038 rows=1 loops=1)
Index Cond: ((pubid)::text = 'books/idea/encyclopediaDB2005/Manjunath05'::text)
Planning time: 0.368 ms
Execution time: 0.060 ms
\end{verbatim}
}


\paragraph{Multipoint Query -- Low Selectivity}

Repeat the following query multiple times with different conditions for {\tt booktitle}.

{\small
\begin{verbatim}
SELECT * FROM Publ WHERE booktitle = ...
\end{verbatim}
}

\noindent
Which conditions did you use?\\
We used a equality condition where the index matches a given string from the booktitle row of the publ.tsv file, like 'Software Engineering (Workshops)'.

\smallskip\noindent
Show the runtime results and compute the throughput.\\
For the Non-Clustered Hash Index we achieved a runtime from 12447$ms$ to 11347$ms$ with 719 searched values.
This leads to a throughput of 57,8$\frac{queries}{second}$ to 76,9$\frac{queries}{second}$.\\

\smallskip\noindent
Query plan (for one of the queries):
\begin{verbatim}
EXPLAIN SELECT * FROM publ_h WHERE booktitle = 'Software Engineering (Workshops)';

 Bitmap Heap Scan on publ_h  (cost=5.37..668.34 rows=177 width=112)
   Recheck Cond: ((booktitle)::text = 'Software Engineering (Workshops)'::text)
   ->  Bitmap Index Scan on booktitleh  (cost=0.00..5.33 rows=177 width=0)
          Index Cond: ((booktitle)::text = 'Software Engineering (Workshops)'::text)
(4 rows)
\end{verbatim}


\paragraph{Multipoint Query -- High Selectivity}

Repeat the following query multiple times with different conditions for {\tt year}.

{\small
\begin{verbatim}
SELECT * FROM Publ WHERE year = ...
\end{verbatim}
}

\noindent
Which conditions did you use?\\
The conditions were imported from a file which contains the years from 1920-2020 repeated up to a total amount of 1500 years.

\smallskip\noindent
Show the runtime results and compute the throughput.\\
Runtime (ms): 86386
Throughput (q/s): 17.363924710022456

\smallskip\noindent
Query plan (for one of the queries):
{\small
\begin{verbatim}
 Bitmap Heap Scan on publ_h  (cost=68.65..6436.08 rows=2149 width=113) (actual time=2.409..32.008 rows=9182 loops=1)
   Recheck Cond: ((year)::text = '1986'::text)
   Heap Blocks: exact=3258
   ->  Bitmap Index Scan on yearh  (cost=0.00..68.12 rows=2149 width=0) (actual time=1.824..1.824 rows=9182 loops=1)
         Index Cond: ((year)::text = '1986'::text)
 Planning time: 0.346 ms
 Execution time: 35.861 ms
\end{verbatim}
}


\section{Table Scan}

\noindent \emph{Note:} Make sure the data is not physically ordered by
the indexed attributes due to the clustering index that you created
before.

\paragraph{Point Query}

{\small
\begin{verbatim}
SELECT * FROM Publ WHERE pubID = ...
\end{verbatim}
}

\noindent
For this query we created a text file containing about 300 randomly selected pubids from the publ.tsv file. Queries were then executed for each entry in that file. The reason we used a different dataset is the enormous amount of time 20000 sequential scan queries would have taken.

\smallskip\noindent
Runtime: 75518ms.\\
Queries: 297.\\
Throughput: about 3.9 queries/sec.

\smallskip\noindent
Query plan (for one of the queries):
{\small
\begin{verbatim}
query plan
\end{verbatim}
}


\paragraph{Multipoint Query -- Low Selectivity}

{\small
\begin{verbatim}
SELECT * FROM Publ WHERE booktitle = ...
\end{verbatim}
}

\noindent
Which conditions did you use?\\
We used a equality condition where the index matches a given string from the booktitle row of the publ.tsv file, like 'Software Engineering (Workshops)'.

\smallskip\noindent
Show the runtime results and compute the throughput.\\
For the Table Scan we achieved a runtime from 197998$ms$ to 201809$ms$ with 719 searched values.
This leads to a throughput of 3,6$\frac{queries}{second}$.\\

\smallskip\noindent
Query plan (for one of the queries):
\begin{verbatim}
EXPLAIN SELECT * FROM publ_s WHERE booktitle = 'Software Engineering (Workshops)';

 Seq Scan on publ_s  (cost=0.00..37843.18 rows=179 width=112)
   Filter: ((booktitle)::text = 'Software Engineering (Workshops)'::text)
(2 rows)
\end{verbatim}


\paragraph{Multipoint Query -- High Selectivity}

{\small
\begin{verbatim}
SELECT * FROM Publ WHERE year = ...
\end{verbatim}
}

\noindent
Which conditions did you use?\\
The conditions were imported from a file which contains the years from 1920-2020 repeated up to a total amount of 1500 years.

\smallskip\noindent
Show the runtime results and compute the throughput.\\
Runtime (ms): 485258
Throughput (q/s): 3.0911391465983042

\smallskip\noindent
Query plan (for one of the queries):
{\small
\begin{verbatim}
 Seq Scan on publ_s  (cost=0.00..37777.18 rows=2224 width=112) (actual time=0.041..354.600 rows=9182 loops=1)
   Filter: ((year)::text = '1986'::text)
   Rows Removed by Filter: 1224032
 Planning time: 0.746 ms
 Execution time: 358.390 ms
\end{verbatim}
}

\section{Discussion}

Give the throughput of the query types and index types in queries/second.
\begin{center}
  \begin{tabular}{c|c|c|c|c}
    & clustered & non-clust.\ B$^+$-tree & non-clust.\ hash & table scan \\
    \hline
    point ({\tt pubID}) & 302 & 305 & 305 & 3,9 \\
    \hline
    multipoint ({\tt booktitle}) & 73,14 & 69,37 & 69,73 & 3,6\\
    \hline
    multipoint  ({\tt year}) & 17,38 & 18,04 & 17,36 & 3,01 \\  
  \end{tabular}
\end{center}

\medskip

Discuss the runtime results for the different index types and the
table scan. Are the results expected? Why / why not?


\bigskip

\noindent Time in hours per person: {\bf XXX}

\bigskip

\begin{center}
  \begin{tabular}{c}
    \hline
    {\bf Important:} Reference your information sources!
    \\\hline
  \end{tabular}
\end{center}

\end{document}
